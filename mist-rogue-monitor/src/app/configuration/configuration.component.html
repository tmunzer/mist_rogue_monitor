<div fxLayout="column" style="height: 100%;">
    <!-- NAV  -->
    <div fxLayout="row" fxLayoutAlign="flex-end center" class="nav">
        <div fxLayout="row" fxLayoutAlign="start">
            <app-nav current="config"></app-nav>
        </div>
        <div style="margin: 1em;" fxLayout="column">
            <button mat-stroked-button color="accent" (click)='back_to_orgs()'>Back to Orgs</button>
        </div>
    </div>
    <!-- MAIN  -->
    <div fxLayout="column" fxLayoutAlign="space-between center">
        <div style="display: grid; grid-template-columns: auto auto;">
            <mat-card>
                <mat-card-title>Status</mat-card-title>
                <mat-card-content>
                    <table>
                        <tr>
                            <th>API Token:</th>
                            <td>
                                <div *ngIf="config.token.configured" fxLayout="row">
                                    <div class="material-icons green">done</div>
                                    <div class="text" *ngIf="config.token.auto_mode">
                                        {{config.token.scope | uppercase }} Token generated by {{config.token.created_by}}
                                    </div>
                                    <div class="text" *ngIf="!config.token.auto_mode">
                                        Token manually configured by {{config.token.created_by}}
                                    </div>
                                </div>
                                <div *ngIf="!config.token.configured" fxLayout="row">
                                    <div class="material-icons red">close</div>
                                    <div class="text">Not Configured</div>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th>Sites Monitoring:</th>
                            <td>
                                <div *ngIf="config.sites.configured" fxLayout="row">
                                    <div class="material-icons green">done</div>
                                    <div class="text" *ngIf="config.sites.all_sites">
                                        All Sites
                                    </div>
                                    <div class="text" *ngIf="!config.sites.all_sites && config.sites.site_ids.length == 1">
                                        {{config.sites.site_ids.length}} Site
                                    </div>
                                    <div class="text" *ngIf="!config.sites.all_sites && config.sites.site_ids.length > 1">
                                        {{config.sites.site_ids.length}} Sites
                                    </div>
                                </div>
                                <div *ngIf="!config.sites.configured" fxLayout="row">
                                    <div class="material-icons red">close</div>
                                    <div class="text">Not Configured</div>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th>Email Alerting:</th>
                            <td>
                                <div *ngIf="config.alert.configured" fxLayout="row">
                                    <div class="material-icons green">done</div>
                                    <div class="text" *ngIf="config.alert.enabled">
                                        Email to {{config.alert.to_emails.length}} email
                                        <span *ngIf="config.alert.to_emails.length <= 1">address</span>
                                        <span *ngIf="config.alert.to_emails.length > 1">addresses</span>
                                    </div>
                                    <div class="text" *ngIf="!config.alert.enabled">
                                        Email Alerting not enabled
                                    </div>

                                </div>
                                <div *ngIf="!config.alert.configured" fxLayout="row">
                                    <div class="material-icons red">close</div>
                                    <div class="text">Not Configured</div>
                                </div>
                            </td>
                        </tr>
                    </table>
                </mat-card-content>
                <mat-card-action fxLayoutAlign="end">
                    <button mat-button color="accent" [disabled]="!account_created" (click)="delete_account()">Delete
                            Org
                            Configuration</button>
                </mat-card-action>
            </mat-card>
            <!-- API Token -->
            <mat-card>
                <mat-card-title fxLayout="row" fxLayoutAlign="start center">API Token
                    <div *ngIf="config.token.configured" class="material-icons green">done</div>
                    <div *ngIf="!config.token.configured" class="material-icons red">close</div>
                </mat-card-title>
                <mat-card-subtitle>This application needs a Mist API Token with write access to create/delete Mist PSKs.
                </mat-card-subtitle>
                <mat-card-content>
                </mat-card-content>
                <mat-card-actions fxLayoutAlign="end">
                    <button mat-button color="accent" [disabled]="!config.token.configured || !config.token.auto_mode || !config.token.can_delete" (click)="delete_token()">Delete Token</button>
                    <button mat-raised-button color="primary" (click)="generate_token('user')">Generate User
                            Token</button>
                    <button mat-raised-button color="primary" (click)="generate_token('org')" *ngIf="privilege == 'admin'">Generate Org Token</button>
                    <button mat-raised-button color="primary" (click)="open_apitoken_manual()">Use Manual
                            Token</button>
                </mat-card-actions>
            </mat-card>
            <!-- Monitored Sites -->
            <mat-card>
                <mat-card-title fxLayout="row" fxLayoutAlign="space-between center">
                    <div>
                        Sites Monitoring
                        <div *ngIf="config.sites.configured" class="material-icons green">done
                        </div>
                        <div *ngIf="!config.sites.configured" class="material-icons red">close
                        </div>
                    </div>

                    <button mat-raised-button color="primary" [disabled]="is_working || !config.token.configured" (click)="save_sites()">Save</button>
                </mat-card-title>
                <mat-card-subtitle>Select the sites you want to monitor.</mat-card-subtitle>
                <mat-card-content>
                    <section fxLayout="row" fxLayoutAlign="start center">
                        <div style="margin-right: 0.5em; margin-bottom: 0.95em;">
                            Sync Rogue list with the Mist Cloud every day at
                        </div>


                        <mat-form-field appearance="outline" style="width: 7em;">
                            <input matInput [ngxMatTimepicker]="pickerB" [format]=24 [(ngModel)]="config.sync_time" />
                            <mat-icon matSuffix (click)="pickerB.open()">
                                watch_later
                            </mat-icon>
                        </mat-form-field>
                        <ngx-mat-timepicker color="primary" #pickerB [minutesGap]=5></ngx-mat-timepicker>



                    </section>
                    <section>
                        <mat-slide-toggle [(ngModel)]="config.sites.all_sites">Monitor all sites</mat-slide-toggle>
                    </section>
                    <div fxLayout="row" style="justify-content: space-between; margin-top: 1em;">

                        <div class="selection-list">
                            <div fxLayout="row" style="align-items: center;">
                                <mat-checkbox style="margin-left: 16px;" [checked]="available_sites_all" (change)="select_all_sites($event.checked, 'available')" [disabled]="config.sites.all_sites">
                                </mat-checkbox>
                                <mat-form-field style="width: 100%; margin-left: 1em;">
                                    <input matInput placeholder="Filter" value="" (ngModelChange)="filter_sites($event, 'available')" [(ngModel)]="filter_available_sites" [disabled]="config.sites.all_sites">
                                </mat-form-field>
                            </div>
                            <div *ngFor="let site of available_sites_filtered" fxLayout="row">
                                <mat-checkbox style="margin: 16px;" [checked]="available_sites_selected.indexOf(site)>=0" (change)="select_site(site, 'available')" [disabled]="config.sites.all_sites">
                                    {{site.name}}
                                </mat-checkbox>
                            </div>
                        </div>
                        <div fxLayout="column" style="justify-content: center;">
                            <button mat-icon-button color="accent" style="margin: 1em 0" [disabled]="config.sites.all_sites" (click)="add_monitored_sites()">
                                    <mat-icon>arrow_forward_ios</mat-icon>
                                </button>
                            <button mat-icon-button color="accent" style="margin: 1em 0" [disabled]="config.sites.all_sites" (click)="remove_monitored_sites()">
                                    <mat-icon>arrow_back_ios_new</mat-icon>
                                </button>
                        </div>
                        <div class="selection-list">
                            <div fxLayout="row" style="align-items: center;">
                                <mat-checkbox style="margin-left: 16px;" [checked]="monitored_sites_all" (change)="select_all_sites($event.checked, 'monitored')" [disabled]="config.sites.all_sites">
                                </mat-checkbox>
                                <mat-form-field style="width: 100%; margin-left: 1em;">
                                    <input matInput placeholder="Filter" value="" (ngModelChange)="filter_sites($event, 'monitored')" [(ngModel)]="filter_monitored_sites" [disabled]="config.sites.all_sites">
                                </mat-form-field>
                            </div>
                            <div *ngFor="let site of monitored_sites_filtered" fxLayout="row">
                                <mat-checkbox style="margin: 16px;" [checked]="monitored_sites_selected.indexOf(site)>=0" (change)="select_site(site, 'monitored')" [disabled]="config.sites.all_sites">
                                    {{site.name}}
                                </mat-checkbox>
                            </div>
                        </div>
                    </div>
                </mat-card-content>
            </mat-card>
            <!-- Alerting -->
            <mat-card>
                <mat-card-title fxLayout="row" fxLayoutAlign="space-between center">
                    <div>

                        Email Alerting
                        <div *ngIf="config.alert.configured" class="material-icons green">done
                        </div>
                        <div *ngIf="!config.alert.configured" class="material-icons red">close
                        </div>
                    </div>

                    <button mat-raised-button color="primary" [disabled]="is_working || !config.token.configured" (click)="save_alert()">Save</button>
                </mat-card-title>
                <mat-card-subtitle></mat-card-subtitle>
                <mat-card-content>
                    <section fxLayout="column">
                        <mat-slide-toggle [(ngModel)]="config.alert.enabled" style="margin-bottom: .5em;">Enable Email Alerting
                        </mat-slide-toggle>
                        <mat-slide-toggle [disabled]="config.alert.enabled==false" [(ngModel)]="config.alert.neighbors">Enable Email Alerting for Neighbors APs
                        </mat-slide-toggle>
                    </section>
                    <div style="justify-content: space-between; margin-top: 1em;" fxLayout="column" fxLayoutAlign="stretch">

                        <div fxLayout="row" style="width: 100%;" fxLayour="row" fxLayoutAlign="start center" [style.color]="config.alert.enabled? 'black':'#b4b4b4'">
                            <div>Send email when a AP is detected for more than </div>
                            <input placeholder="" [(ngModel)]="config.alert.min_age" [disabled]="config.alert.enabled==false" type="number" min="0" style="padding: 5px;width: 3em;margin: 5px;">
                            <div *ngIf="config.alert.min_age <= 1">day</div>
                            <div *ngIf="config.alert.min_age > 1">days</div>
                        </div>
                        <span [style.color]="config.alert.enabled? 'black':'#b4b4b4'" style="font-size: smaller;"> (0 means email is sent just after the first sync where the AP is detected) </span>

                        <mat-form-field>
                            <mat-label>Alert Emails Recipients</mat-label>
                            <mat-chip-list #chipList aria-label="Emails">
                                <mat-chip *ngFor="let email of config.alert.to_emails" removable="true" (removed)="remove_email(email)">
                                    {{email}}
                                    <button matChipRemove>
                                            <mat-icon>cancel</mat-icon>
                                        </button>
                                </mat-chip>
                                <input placeholder="New Email..." [disabled]="!config.alert.enabled" [matChipInputFor]="chipList" [matChipInputSeparatorKeyCodes]="separatorKeysCodes" matChipInputAddOnBlur="true" (matChipInputTokenEnd)="add_email($event)">
                            </mat-chip-list>
                        </mat-form-field>

                    </div>
                </mat-card-content>
            </mat-card>
        </div>
    </div>
</div>